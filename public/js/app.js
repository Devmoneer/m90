const translations = {
    en: {
        login_title: "Login | Stock Exchange",
        username: "Username",
        password: "Password",
        login_button: "Login",
        forgot_password: "? Forgot password",
        create_account: "Create new account",
        signup_title: "Sign Up",
        full_name: "Full Name",
        email: "Email",
        confirm_password: "Confirm Password",
        signup_button: "Sign Up",
        already_have_account: "Already have an account? Login",
        error_empty_field: "Please fill in this field",
        error_invalid_email: "Invalid email format",
        error_password_mismatch: "Passwords don't match",
        login_success: "Login successful!",
        delete_confirm: "Are you sure you want to delete your account? This cannot be undone."
    },
    ar: {
        login_title: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
        username: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
        password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        login_button: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
        forgot_password: "Ù‡Ù„ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ",
        create_account: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯",
        signup_title: "ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯",
        full_name: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„",
        email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
        confirm_password: "ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        signup_button: "ØªØ³Ø¬ÙŠÙ„",
        already_have_account: "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
        error_empty_field: "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„",
        error_invalid_email: "ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­Ø©",
        error_password_mismatch: "ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©",
        login_success: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!",
        delete_confirm: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø­Ø³Ø§Ø¨ÙƒØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡."
    },
    ckb: {
        login_title: "Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ• | Ø¨Û†Ø±Ø³Û•",
        username: "Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±",
        password: "ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ",
        login_button: "Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•",
        forgot_password: "ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒØª Ù„Û•Ø¨ÛŒØ±Ú©Ø±Ø¯ÙˆÙˆÛ•ØŸ",
        create_account: "Ø­ÛŒØ³Ø§Ø¨ÛÚ©ÛŒ Ù†ÙˆÛ Ø¯Ø±ÙˆØ³Øª Ø¨Ú©Û•",
        signup_title: "ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†",
        full_name: "Ù†Ø§ÙˆÛŒ ØªÛ•ÙˆØ§Ùˆ",
        email: "Ø¦ÛŒÙ…Û•ÛŒÚµ",
        confirm_password: "Ø¯ÙˆÙˆØ¨Ø§Ø±Û•Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ",
        signup_button: "ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†",
        already_have_account: "Ù‡Û•Ú˜Ù…Ø§Ø±Øª Ù‡Û•ÛŒÛ•ØŸ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•",
        error_empty_field: "ØªÚ©Ø§ÛŒÛ• Ø¦Û•Ù… Ø®Ø§Ù†Û• Ù¾Ú• Ø¨Ú©Û•Ø±Û•ÙˆÛ•",
        error_invalid_email: "ÙÛ†Ø±Ù…Ø§ØªÛŒ Ø¦ÛŒÙ…Û•ÛŒÚµ Ù†Ø§Ø¯Ø±ÙˆØ³ØªÛ•",
        error_password_mismatch: "ÙˆØ´Û• Ù†Ù‡ÛÙ†ÛŒÛ•Ú©Ø§Ù† Ù†Ø§Ú¯ÙˆÙ†Ø¬Ø§ÙˆÙ†",
        login_success: "Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆØ¨ÙˆÙˆ!",
        delete_confirm: "Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ú©Û• Ø¯Û•ØªÛ•ÙˆÛØª Ù‡Û•Ú˜Ù…Ø§Ø±Û•Ú©Û• Ø¨Ø³Ú•ÛŒØªÛ•ÙˆÛ•ØŸ Ù†Ø§ØªÙˆØ§Ù†ÛŒØª Ø¦Û•Ù… Ú©Ø§Ø±Û• Ø¨Ú¯Û•Ú•ÛÙ†ÛŒØªÛ•ÙˆÛ•."
    },
    badini: {
        login_title: "Ú†ÙˆÙˆÙ†Ø§Ú˜ÙˆÙˆØ± | Ø¨Û†Ø±Ø³Û•",
        username: "Ù†Ø§Ú¤Û Ø¨Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±ÛŒ",
        password: "Ù¾Û•ÛŒÚ¤Ø§ Ù†Ù‡ÛÙ†ÛŒ",
        login_button: "Ú†ÙˆÙˆÙ†Ø§Ú˜ÙˆÙˆØ±",
        forgot_password: "Ù¾Û•ÛŒÚ¤Ø§ Ù†Ù‡ÛÙ†ÛŒ ØªÛ• Ú˜Ø¨ÛŒØ±Ú©Ø±ÛŒÛ•ØŸ",
        create_account: "Ù‡Ú˜Ù…Ø§Ø±Û•Ú©Ø§ Ù†ÙˆÛŒ Ø¯Ø±ÙˆØ³Øª Ø¨Ú©Û•",
        signup_title: "ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†",
        full_name: "Ù†Ø§ÙˆÛŒ ØªÛ•ÙˆØ§Ùˆ",
        email: "Ø¦ÛŒÙ…Û•ÛŒÚµ",
        confirm_password: "Ø¯ÙˆÙˆØ¨Ø§Ø±Û•Ú©Ø±Ù†Ø§ Ù¾Û•ÛŒÚ¤Ø§ Ù†Ù‡ÛÙ†ÛŒ",
        signup_button: "ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†",
        already_have_account: "Ù‡Ú˜Ù…Ø§Ø± ØªÛ• Ù‡Û•ÛŒÛ•ØŸ Ú†ÙˆÙˆÙ†Ø§Ú˜ÙˆÙˆØ±",
        error_empty_field: "ØªÚ©Ø§ÛŒÛ• Ø¦Û•Ú¤ Ø®Ø§Ù†Û• Ù¾Ú• Ø¨Ú©Û•",
        error_invalid_email: "ÙÛ†Ø±Ù…Ø§ØªØ§ Ø¦ÛŒÙ…Û•ÛŒÚµÛ Ø±Ø§Ø³Øª Ù†ÛŒÛ•",
        error_password_mismatch: "Ù¾Û•ÛŒÚ¤Ø§Ù† Ù†Ù‡ÛÙ†ÛŒ Ù†Ø§ ÛŒÛ•Ú© Ø¯Û•Ú†Ù†",
        login_success: "Ú†ÙˆÙˆÙ†Ø§Ú˜ÙˆÙˆØ± ÛŒØ§ Ø³Û•Ø±Ú©Û•ÙØªÛŒØ¨ÙˆÙˆ!",
        delete_confirm: "Ø¯Û•Ù‚ÛŒÙ†ÛŒØª Ú©Û• Ø¯Û•Ú¤ÛØª Ù‡Ú˜Ù…Ø§Ø±Û•Ú©Ø§ ØªÛ• Ø¨Ø³Ø±ÛŒØªÛ•Ú¤Û•ØŸ Ù†Û•Ú¤ÛØª Ø¦Û•Ú¤ Ú©Ø§Ø±Û• Ø¨Ú¯Ø±ÛŒØªÛ•Ú¤Û•."
    }
};

let currentUser = null;

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeLanguage();
    setupForms();
    setupViewportHandling();
    setupLanguageSwitcher();
    addNotificationStyles();
});

function initializeLanguage() {
    const savedLang = localStorage.getItem('preferredLanguage') || 
                     (navigator.language.startsWith('ar') ? 'ar' : 
                      navigator.language.startsWith('ckb') ? 'ckb' :
                      navigator.language.startsWith('badini') ? 'badini' : 'en');
    changeLanguage(savedLang);
}

function setupLanguageSwitcher() {
    const languageSwitcher = document.querySelector('.language-switcher');
    
    if (!languageSwitcher) return;
    
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'lang-toggle-btn';
    toggleBtn.innerHTML = `<span class="logo-lang-btn">ğŸŒ</span>`;
    
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'lang-buttons-container';
    
    const existingButtons = Array.from(languageSwitcher.querySelectorAll('.lang-btn'));
    existingButtons.forEach(btn => buttonsContainer.appendChild(btn));
    
    languageSwitcher.innerHTML = '';
    languageSwitcher.appendChild(toggleBtn);
    languageSwitcher.appendChild(buttonsContainer);
    
    toggleBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        buttonsContainer.classList.toggle('show-lang-buttons');
    });
    
    document.addEventListener('click', function() {
        buttonsContainer.classList.remove('show-lang-buttons');
    });
    
    buttonsContainer.addEventListener('click', function(e) {
        e.stopPropagation();
    });
    
    buttonsContainer.querySelectorAll('.lang-btn').forEach(button => {
        button.addEventListener('click', function() {
            const lang = this.getAttribute('data-lang');
            changeLanguage(lang);
            buttonsContainer.classList.remove('show-lang-buttons');
        });
    });
}

function changeLanguage(lang) {
    document.documentElement.lang = lang;
    document.documentElement.dir = ['ar', 'ckb', 'badini'].includes(lang) ? 'rtl' : 'ltr';
    
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translations[lang]?.[key]) {
            element.textContent = translations[lang][key];
        }
    });
    
    localStorage.setItem('preferredLanguage', lang);
}

function setupForms() {
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (validateForm(this)) {
                handleFormSubmission(this);
            }
        });
        
        form.querySelectorAll('input[required]').forEach(input => {
            input.addEventListener('blur', function() {
                if (!this.value.trim()) {
                    showError(this, translations[document.documentElement.lang].error_empty_field);
                } else {
                    hideError(this);
                }
            });
        });
    });
}

function handleFormSubmission(form) {
    const currentLang = document.documentElement.lang;
    showNotification(translations[currentLang].login_success, 'success');
    
    // Store user data
    if (form.id === 'signup-form') {
        currentUser = {
            name: form.querySelector('#full-name')?.value || form.querySelector('#username').value,
            email: form.querySelector('#email').value,
            username: form.querySelector('#username').value
        };
    } else if (form.id === 'login-form') {
        currentUser = {
            username: form.querySelector('#username').value,
            name: form.querySelector('#username').value,
            email: form.querySelector('#username').value + "@example.com"
        };
    }
    
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    
    setTimeout(() => {
        window.location.href = '../html/home.html'; 
    }, 2000);
}

function validateForm(form) {
    let isValid = true;
    const inputs = form.querySelectorAll('input[required]');
    const currentLang = document.documentElement.lang;
    
    inputs.forEach(input => hideError(input));
    
    inputs.forEach(input => {
        if (!input.value.trim()) {
            isValid = false;
            showError(input, translations[currentLang].error_empty_field);
            animateError(input);
        } else {
            if (input.type === 'email' && !validateEmail(input.value)) {
                isValid = false;
                showError(input, translations[currentLang].error_invalid_email);
                animateError(input);
            }
            
            if (input.id === 'confirm-password') {
                const password = form.querySelector('#password').value;
                if (input.value !== password) {
                    isValid = false;
                    showError(input, translations[currentLang].error_password_mismatch);
                    animateError(input);
                }
            }
        }
    });
    
    if (!isValid) {
        showNotification(translations[currentLang].error_empty_field, 'error');
    }
    
    return isValid;
}

function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function showError(input, message) {
    let errorSpan = input.nextElementSibling;
    
    if (!errorSpan || !errorSpan.classList.contains('error-message')) {
        errorSpan = document.createElement('span');
        errorSpan.className = 'error-message';
        input.parentNode.insertBefore(errorSpan, input.nextSibling);
    }
    
    errorSpan.textContent = message;
    input.classList.add('error');
}

function hideError(input) {
    const errorSpan = input.nextElementSibling;
    if (errorSpan && errorSpan.classList.contains('error-message')) {
        errorSpan.remove();
    }
    input.classList.remove('error');
}

function animateError(input) {
    input.style.animation = 'none';
    void input.offsetWidth; 
    input.style.animation = 'shake 0.5s';
    
    setTimeout(() => {
        input.style.animation = '';
    }, 500);
}

function showNotification(message, type = 'error') {
    const existingNotification = document.querySelector('.form-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `form-notification notification-${type}`;
    notification.textContent = message;
    
    const form = document.querySelector('form');
    if (form) {
        form.insertBefore(notification, form.firstChild);
    }
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

function addNotificationStyles() {
    const notificationCSS = `
    .form-notification {
        position: relative;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 10px;
        color: white;
        text-align: center;
        animation: slideDown 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: opacity 0.3s ease;
    }
    
    .notification-error {
        background-color: #ff4444;
    }
    
    .notification-success {
        background-color: #1F7D53;
    }
    
    @keyframes slideDown {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    `;

    const styleElement = document.createElement('style');
    styleElement.innerHTML = notificationCSS;
    document.head.appendChild(styleElement);
}

function setupViewportHandling() {
    function setViewport() {
        const viewport = document.querySelector('meta[name="viewport"]');
        if (viewport) {
            if (window.innerWidth <= 768) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
            } else {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
            }
        }
    }
    
    setViewport();
    window.addEventListener('resize', setViewport);
    document.addEventListener('touchstart', function() {}, {passive: true});
}

// User management functions
function checkLoginStatus() {
    const userData = localStorage.getItem('currentUser');
    if (userData) {
        currentUser = JSON.parse(userData);
        return true;
    }
    return false;
}

function logout() {
    localStorage.removeItem('currentUser');
    currentUser = null;
    window.location.href = '../index.html';
}

function deleteAccount() {
    const currentLang = document.documentElement.lang;
    if (confirm(translations[currentLang].delete_confirm || "Are you sure you want to delete your account? This cannot be undone.")) {
        localStorage.removeItem('currentUser');
        currentUser = null;
        window.location.href = '../index.html';
    }
}